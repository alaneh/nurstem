<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario y Farmacia - Nurstem</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/inventory.css') }}">
</head>
<body>

    <div class="main-layout">
        <aside class="sidebar">
            <div class="brand"><h2>Nurstem</h2></div>
            <nav class="nav-menu">
                <a href="{{ url_for('admin_personal') }}" class="nav-link">Personal</a>
                <a href="{{ url_for('admin_pacientes') }}" class="nav-link">Pacientes</a>
                <a href="{{ url_for('admin_asignaciones') }}" class="nav-link">Asignaciones</a>
                <a href="{{ url_for('admin_dashboard') }}" class="nav-link">Dashboard</a>
                <a href="{{ url_for('admin_capacitacion') }}" class="nav-link">Capacitación</a>
                <a href="{{ url_for('admin_inventario') }}" class="nav-link active">Inventario</a>
            </nav>
        </aside>

        <main class="content-area">
            <div class="module-container">
                
                {% with messages = get_flashed_messages(with_categories=true) %}
                  {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}" style="padding:10px; margin-bottom:15px; border-radius:6px; background:#e0f2fe; color:#0369a1;">{{ message }}</div>
                    {% endfor %}
                  {% endif %}
                {% endwith %}

                <div class="inventory-header">
                    <div class="header-info">
                        <h1>Gestión de Insumos y Farmacia</h1>
                        <p>Control de stock, lotes y caducidades</p>
                    </div>
                    <div class="filter-tabs">
                        <a href="{{ url_for('admin_inventario') }}" class="tab-btn {% if not filtro_actual %}active{% endif %}">Todos</a>
                        <a href="{{ url_for('admin_inventario', tipo='Medicamento') }}" class="tab-btn {% if filtro_actual == 'Medicamento' %}active{% endif %}">Medicamentos</a>
                        <a href="{{ url_for('admin_inventario', tipo='Material') }}" class="tab-btn {% if filtro_actual == 'Material' %}active{% endif %}">Material de Curación</a>
                        <button class="tab-btn tab-alert">Stock Crítico ({{ alertas_count }})</button>
                    </div>
                </div>

                <div class="toolbar">
                    <div class="toolbar-actions" style="width: 100%; justify-content: space-between;">
                        <input type="text" class="search-bar" placeholder="Buscar por nombre o código...">
                        <button class="btn-primary" onclick="openProductModal()"><span>+</span> Nuevo Producto</button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table-data table-inventory">
                        <thead>
                            <tr>
                                <th>Código / Lote</th>
                                <th>Producto</th>
                                <th>Presentación</th>
                                <th>Caducidad</th>
                                <th>Ubicación</th>
                                <th class="text-center">Stock</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for prod in productos %}
                            <tr class="{% if prod.stock <= prod.punto_reorden %}row-alert{% endif %}">
                                <td>
                                    <span class="code-text">{{ prod.codigo }}</span>
                                    <div class="batch-text">Lote: {{ prod.lote or 'N/A' }}</div>
                                </td>
                                <td>
                                    <div class="product-name {% if prod.stock <= prod.punto_reorden %}text-danger{% endif %}">{{ prod.nombre }}</div>
                                    <div class="product-sub">{{ prod.tipo }}</div>
                                </td>
                                <td>{{ prod.presentacion }}</td>
                                <td>
                                    {% if prod.fecha_caducidad %}
                                        {{ prod.fecha_caducidad }}
                                    {% else %}
                                        <span style="color:#94a3b8;">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if prod.ubicacion %}
                                        {{ prod.ubicacion.nombre }}
                                    {% else %}
                                        General
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if prod.stock <= prod.punto_reorden %}
                                        <span class="stock-badge stock-critical">{{ prod.stock }}</span>
                                    {% elif prod.stock < (prod.punto_reorden * 2) %}
                                        <span class="stock-badge stock-low">{{ prod.stock }}</span>
                                    {% else %}
                                        <span class="stock-badge stock-healthy">{{ prod.stock }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn-icon" title="Ajustar Stock" 
                                        onclick="openStockModal('{{ prod.id }}', '{{ prod.nombre }}', {{ prod.stock }})">
                                        ⇄
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="7" style="text-align:center; padding:2rem;">No hay productos registrados.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="modalProduct" class="modal">
        <div class="modal-content modal-lg">
            <h2 class="modal-title">Registrar Nuevo Producto</h2>
            <form action="{{ url_for('guardar_producto') }}" method="POST">
                <div class="form-row">
                    <div class="form-group col-half">
                        <label>Código Interno</label>
                        <input type="text" name="codigo" class="form-input" placeholder="Ej. MED-001" required>
                    </div>
                    <div class="form-group col-half">
                        <label>Nombre Comercial</label>
                        <input type="text" name="nombre" class="form-input" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group col-third">
                        <label>Tipo</label>
                        <select name="tipo" class="form-select">
                            <option value="Medicamento">Medicamento</option>
                            <option value="Material">Material Curación</option>
                            <option value="Solucion">Soluciones / Sueros</option>
                        </select>
                    </div>
                    <div class="form-group col-third">
                        <label>Presentación</label>
                        <input type="text" name="presentacion" class="form-input" placeholder="Ej. Caja 20 tabs">
                    </div>
                    <div class="form-group col-third">
                        <label>Ubicación</label>
                        <select name="inventario_id" class="form-select">
                            {% for alm in almacenes %}
                                <option value="{{ alm.id }}">{{ alm.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group col-half">
                        <label>Lote</label>
                        <input type="text" name="lote" class="form-input">
                    </div>
                    <div class="form-group col-half">
                        <label>Caducidad</label>
                        <input type="date" name="fecha_caducidad" class="form-input">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group col-half">
                        <label>Stock Inicial</label>
                        <input type="number" name="stock" class="form-input" value="0">
                    </div>
                    <div class="form-group col-half">
                        <label>Punto Reorden (Alerta)</label>
                        <input type="number" name="punto_reorden" class="form-input" value="10">
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeModal('modalProduct')">Cancelar</button>
                    <button type="submit" class="btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalStock" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <h2 class="modal-title">Movimiento de Stock</h2>
            <form action="{{ url_for('movimiento_stock') }}" method="POST">
                <input type="hidden" id="stock_prod_id" name="producto_id">
                <input type="hidden" id="stock_tipo_mov" name="tipo_movimiento" value="entrada"> <div class="stock-adjustment-container">
                    <p id="productNameTitle" style="color:#64748b; font-weight:600; margin-bottom:1rem; text-align:center;">Producto X</p>
                    
                    <div class="current-stock-display">
                        <span>Stock Actual:</span>
                        <strong id="currentStockDisplay">0</strong>
                    </div>

                    <div class="adjustment-controls">
                        <button type="button" class="btn-adjust type-minus" onclick="setMovementMode('salida')">- Salida</button>
                        <input type="number" name="cantidad" class="input-adjust" value="1" min="1" required>
                        <button type="button" class="btn-adjust type-plus" onclick="setMovementMode('entrada')">+ Entrada</button>
                    </div>
                    
                    <p id="movLabel" style="text-align:center; margin-top:10px; font-size:0.9rem; font-weight:bold; color:#16a34a;">Modo: Entrada</p>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeModal('modalStock')">Cancelar</button>
                    <button type="submit" class="btn-primary">Confirmar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function openProductModal() { document.getElementById('modalProduct').style.display = 'flex'; }
        
        function openStockModal(id, name, stock) {
            document.getElementById('stock_prod_id').value = id;
            document.getElementById('productNameTitle').innerText = name;
            document.getElementById('currentStockDisplay').innerText = stock;
            setMovementMode('entrada'); // Reset default
            document.getElementById('modalStock').style.display = 'flex';
        }

        function setMovementMode(mode) {
            document.getElementById('stock_tipo_mov').value = mode;
            const label = document.getElementById('movLabel');
            if(mode === 'entrada') {
                label.innerText = "Modo: Entrada (Compras)";
                label.style.color = "#16a34a";
            } else {
                label.innerText = "Modo: Salida (Consumo/Merma)";
                label.style.color = "#dc2626";
            }
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        window.onclick = function(e) { if(e.target.classList.contains('modal')) e.target.style.display = 'none'; }
    </script>
</body>
</html>